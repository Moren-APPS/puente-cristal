<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hand Tracking: Grab & Drop Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #111; color: white; }
        .container { position: relative; width: 100vw; height: 100vh; }
        .input_video { display: none; }
        .output_canvas { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; }
        #info { position: absolute; top: 10px; width: 100%; text-align: center; z-index: 100; font-size: 1.2em; text-shadow: 1px 1px 2px black;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>

<body>
  <div id="info">Junta el pulgar y el índice para agarrar el cubo.</div>
  <div class="container">
    <video class="input_video"></video>
    <canvas class="output_canvas" width="1280px" height="720px"></canvas>
    <div class="loading">
      <p>Cargando modelos de IA...</p>
    </div>
  </div>

  <script type="module">
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');
    const loadingElement = document.querySelector('.loading');

    // --- Variables del Juego ---
    let isGrabbing = false;
    let cube = { x: 300, y: 300, size: 80, color: '#007BFF' }; // Posición inicial del cubo

    function onResults(results) {
      loadingElement.style.display = 'none';

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      
      // Dibuja el cubo
      canvasCtx.fillStyle = cube.color;
      canvasCtx.fillRect(cube.x - cube.size / 2, cube.y - cube.size / 2, cube.size, cube.size);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // --- Lógica de Agarrar ---
        const thumbTip = landmarks[4];
        const indexTip = landmarks[8];
        
        const fingerDistance = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
        const isPinched = fingerDistance < 0.07; // Umbral para detectar la pinza

        const indexTipX = indexTip.x * canvasElement.width;
        const indexTipY = indexTip.y * canvasElement.height;
        
        // Distancia entre el dedo y el cubo
        const distToCube = Math.hypot(indexTipX - cube.x, indexTipY - cube.y);
        
        if (isPinched && !isGrabbing && distToCube < cube.size) {
            // Iniciar agarre si el dedo está cerca del cubo y hace pinza
            isGrabbing = true;
            cube.color = '#FFD700'; // Cambiar a color amarillo al agarrar
        } else if (!isPinched) {
            // Soltar si los dedos se separan
            if (isGrabbing) {
                isGrabbing = false;
                cube.color = '#007BFF'; // Volver al color original
            }
        }

        // Mover el cubo si está siendo agarrado
        if (isGrabbing) {
            cube.x = indexTipX;
            cube.y = indexTipY;
        }

        // Dibujar un puntero en el dedo índice para feedback visual
        canvasCtx.beginPath();
        canvasCtx.arc(indexTipX, indexTipY, 15, 0, 2 * Math.PI);
        canvasCtx.fillStyle = isGrabbing ? 'rgba(255, 215, 0, 0.8)' : 'rgba(255, 0, 0, 0.5)';
        canvasCtx.fill();
        canvasCtx.strokeStyle = 'white';
        canvasCtx.lineWidth = 2;
        canvasCtx.stroke();
      } else {
        // Si no se detecta mano, soltar el objeto
        if (isGrabbing) {
            isGrabbing = false;
            cube.color = '#007BFF';
        }
      }
      canvasCtx.restore();
    }

    const hands = new Hands({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`;
    }});
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({image: videoElement});
      },
      width: 1280,
      height: 720
    });
    camera.start();
  </script>
</body>
</html>


