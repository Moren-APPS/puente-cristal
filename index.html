<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Reto Dalgona: Hand Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; font-family: 'Helvetica Neue', sans-serif; background-color: #0d0d0d; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        /* El canvas de la cámara y el de la galleta ahora están separados */
        #ar-canvas, #game-canvas { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 100%; border-radius: 10px; }
        #ar-canvas { transform: translate(-50%, -50%) scaleX(-1); z-index: 1; } /* Cámara en el fondo */
        #game-canvas { z-index: 2; pointer-events: none; } /* Galleta encima */
        #timer { position: absolute; top: 20px; right: 20px; font-size: 2em; color: white; text-shadow: 2px 2px 4px #000; z-index: 30; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 100; padding: 20px; box-sizing: border-box; }
        .content { background-color: rgba(20, 20, 20, 0.9); padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 165, 0, 0.5); border: 1px solid rgba(255, 165, 0, 0.7); }
        h1 { font-size: 2.5em; margin-bottom: 10px; color: #FFA500; text-shadow: 0 0 10px #FFA500; }
        button { padding: 15px 30px; font-size: 1.2em; background-color: #FFA500; color: #0d0d0d; border: none; border-radius: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold; margin: 5px; }
        #loading { display: none; color: white; font-size: 1.5em; }
        #errorMessage { display: none; color: #f87171; margin-top: 20px; max-width: 80%; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="overlay">
        <div class="content">
            <h1>Reto Dalgona</h1>
            <p>Usa tu dedo índice para cortar la galleta.<br>Elige una forma para empezar.</p>
            <div id="shape-selector" style="margin-bottom: 20px;">
                <button id="btn-triangle">Triángulo</button>
                <button id="btn-star">Estrella</button>
                <button id="btn-umbrella">Paraguas</button>
            </div>
             <div id="loading">Iniciando cámara...</div>
             <p id="errorMessage"></p>
        </div>
    </div>
    
    <div id="container">
        <video id="webcam" style="display: none;" playsinline></video>
        <canvas id="ar-canvas"></canvas>
        <canvas id="game-canvas"></canvas>
    </div>
    <div id="timer">60</div>

    <script>
        const overlay = document.getElementById('overlay');
        const videoElement = document.getElementById('webcam');
        const arCanvas = document.getElementById('ar-canvas');
        const arCtx = arCanvas.getContext('2d');
        const gameCanvas = document.getElementById('game-canvas');
        const gameCtx = gameCanvas.getContext('2d');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('errorMessage');
        const timerElement = document.getElementById('timer');
        
        let hands, animationFrameId;
        let gameActive = false, timerInterval, timeLeft = 60, isTracing = false;

        document.getElementById('btn-triangle').onclick = () => startGame('triangle');
        document.getElementById('btn-star').onclick = () => startGame('star');
        document.getElementById('btn-umbrella').onclick = () => startGame('umbrella');

        function drawShape(ctx, shape, size) {
            const center = size / 2;
            ctx.clearRect(0, 0, size, size);
            // Dibujar galleta de fondo
            ctx.fillStyle = 'rgba(240, 194, 123, 0.8)';
            ctx.beginPath();
            ctx.arc(center, center, size * 0.45, 0, Math.PI * 2);
            ctx.fill();
            // Dibujar contorno de la forma
            ctx.strokeStyle = 'rgba(191, 123, 40, 0.7)';
            ctx.lineWidth = size * 0.015;
            ctx.beginPath();

            switch (shape) {
                case 'triangle':
                    const triRadius = size * 0.25;
                    ctx.moveTo(center, center - triRadius);
                    ctx.lineTo(center + triRadius * Math.cos(Math.PI / 6), center + triRadius * Math.sin(Math.PI / 6));
                    ctx.lineTo(center - triRadius * Math.cos(Math.PI / 6), center + triRadius * Math.sin(Math.PI / 6));
                    ctx.closePath();
                    break;
                case 'star':
                    const spikes = 5, outerRadius = size * 0.25, innerRadius = size * 0.1;
                    let rot = Math.PI / 2 * 3;
                    let x = center, y = center;
                    let step = Math.PI / spikes;
                    ctx.moveTo(center, center - outerRadius);
                    for (let i = 0; i < spikes; i++) {
                        x = center + Math.cos(rot) * outerRadius;
                        y = center + Math.sin(rot) * outerRadius;
                        ctx.lineTo(x, y);
                        rot += step;
                        x = center + Math.cos(rot) * innerRadius;
                        y = center + Math.sin(rot) * innerRadius;
                        ctx.lineTo(x, y);
                        rot += step;
                    }
                    ctx.closePath();
                    break;
                case 'umbrella':
                    const umbRadius = size * 0.2;
                    ctx.arc(center, center, umbRadius, Math.PI, 0);
                    ctx.moveTo(center - umbRadius, center);
                    ctx.lineTo(center + umbRadius, center);
                    ctx.moveTo(center, center);
                    ctx.lineTo(center, center + umbRadius * 1.5);
                    ctx.moveTo(center, center + umbRadius * 1.5);
                    ctx.arc(center - umbRadius * 0.2, center + umbRadius * 1.5, umbRadius * 0.2, 0, Math.PI / 2);
                    break;
            }
            ctx.stroke();
        }

        function onResults(results) {
            if (loadingElement.style.display !== 'none') {
                loadingElement.style.display = 'none';
                document.getElementById('game-ui').style.display = 'flex';
            }

            arCanvas.width = videoElement.videoWidth;
            arCanvas.height = videoElement.videoHeight;
            
            arCtx.save();
            arCtx.clearRect(0, 0, arCanvas.width, arCanvas.height);
            arCtx.drawImage(videoElement, 0, 0, arCanvas.width, arCanvas.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0]; // Usar solo la primera mano detectada
                drawConnectors(arCtx, landmarks, HAND_CONNECTIONS, { color: 'rgba(0, 255, 0, 0.5)', lineWidth: 5 });
                drawLandmarks(arCtx, landmarks, { color: 'rgba(255, 0, 0, 0.7)', lineWidth: 2 });
                
                // Usar el dedo índice para cortar
                const indexFingerTip = landmarks[8];
                const gameContainerRect = document.querySelector('.game-container').getBoundingClientRect();
                
                // Convertir coordenadas normalizadas de la IA (0.0 a 1.0) a coordenadas del canvas del juego
                const x = indexFingerTip.x * gameCanvas.width;
                const y = indexFingerTip.y * gameCanvas.height;

                checkCut(x, y);
            } else {
                 isTracing = false;
            }
            arCtx.restore();
        }
        
        async function startGame(shape) {
            overlay.querySelector('#shape-selector').style.display = 'none';
            loadingElement.style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720, facingMode: 'user' } // Usar cámara frontal
                });
                videoElement.srcObject = stream;
                videoElement.play();

                videoElement.onloadedmetadata = () => {
                    const gameContainerSize = document.querySelector('.game-container').offsetWidth;
                    gameCanvas.width = gameContainerSize;
                    gameCanvas.height = gameContainerSize;

                    drawShape(gameCtx, shape, gameContainerSize);

                    hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                    hands.onResults(onResults);

                    sendToHands();
                    
                    timeLeft = 60;
                    timerElement.textContent = timeLeft;
                    gameActive = true;
                    timerInterval = setInterval(updateTimer, 1000);
                };

            } catch (err) {
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `Error al iniciar la cámara: ${err.message}. Asegúrate de haber dado permiso.`;
                console.error(err);
            }
        }
        
        async function sendToHands() {
            if (!videoElement.paused && !videoElement.ended) {
                await hands.send({ image: videoElement });
            }
            animationFrameId = requestAnimationFrame(sendToHands);
        }

        function checkCut(x, y) {
            if (!gameActive) return;

            const pixelData = gameCtx.getImageData(x, y, 1, 1).data;
            const isOnPath = pixelData[3] > 0; // El path tiene alpha, el fondo no

            if (!isOnPath && isTracing) { // Solo pierde si se sale MIENTRAS traza
                endGame(false);
            } else if (isOnPath) {
                if (!isTracing) {
                    isTracing = true;
                }
            }
        }

        function updateTimer() {
            if (!gameActive) return;
            timeLeft--;
            timerElement.textContent = timeLeft;
            if (timeLeft <= 0) {
                endGame(false);
            }
        }

        function endGame(isWin) {
            if (!gameActive) return;
            
            gameActive = false;
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrameId);
            
            const h1 = overlay.querySelector('h1');
            const p = overlay.querySelector('p');
            const crackImg = document.getElementById('crack-img');

            if (isWin) {
                h1.textContent = "¡Felicidades!";
                p.textContent = "Has cortado la galleta a la perfección.";
            } else {
                crackImg.style.display = 'block';
                setTimeout(() => crackImg.style.opacity = '1', 50);
                h1.textContent = "¡Has Perdido!";
                p.textContent = "La galleta se ha roto.";
            }
            
            overlay.querySelector('#shape-selector').innerHTML = '<button onclick="window.location.reload()">Jugar de Nuevo</button>';
            overlay.style.display = 'flex';
        }
    </script>
</body>
</html>

