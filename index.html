<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Aventura de Manos Estilo Mario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; font-family: 'Press Start 2P', sans-serif; background-color: #5C94FC; overflow: hidden; }
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        #container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        video, canvas { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scaleX(-1); max-width: 100%; max-height: 100%; border-radius: 10px; }
        canvas { background-color: transparent; }
        #gameCanvas { z-index: 1; }
        #webcam { z-index: 0; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 10; padding: 20px; box-sizing: border-box; }
        h1 { font-size: 2em; margin-bottom: 20px; text-shadow: 3px 3px #000; }
        p { max-width: 80%; line-height: 1.5; font-size: 1.2em; }
        button { padding: 15px 30px; font-size: 1.2em; background-color: #fbd000; color: #000; border: 4px solid #000; border-radius: 10px; cursor: pointer; font-weight: bold; font-family: 'Press Start 2P', sans-serif; }
        #loading { display: none; z-index: 5; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.5em; background-color: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="overlay">
        <h1>¡Aventura de Manos!</h1>
        <p>¡Corre hacia adelante y salta para romper los bloques con tu mano!</p>
        <button id="startButton">Iniciar Juego</button>
    </div>
    <div id="container">
        <video id="webcam" playsinline></video>
        <canvas id="gameCanvas"></canvas>
        <div id="loading">Cargando modelos de IA...</div>
    </div>
    <script>
        const startButton = document.getElementById('startButton');
        const overlay = document.getElementById('overlay');
        const videoElement = document.getElementById('webcam');
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');
        const loadingElement = document.getElementById('loading');
        
        let hands, activeStream;
        let handsInitialized = false;
        const smoothingFactor = 0.4;

        // --- ESTADO DEL JUEGO ---
        let player = null;
        let blocks = [];
        let score = 0;
        let blockSpawnTimer = 0;
        const PUNCH_VELOCITY_THRESHOLD = 5; // Sensibilidad del golpe

        // --- Clase para los Bloques ---
        class Block {
            constructor() {
                this.width = 80;
                this.height = 80;
                this.x = Math.random() * (gameCanvas.width - this.width);
                this.y = -this.height;
                this.speed = 2 + Math.random() * 2; // Velocidad aleatoria
                this.active = true;
            }

            update() {
                this.y += this.speed;
                if (this.y > gameCanvas.height) {
                    this.active = false;
                }
            }

            draw() {
                // Caja principal
                gameCtx.fillStyle = '#D95E00';
                gameCtx.fillRect(this.x, this.y, this.width, this.height);
                gameCtx.strokeStyle = 'black';
                gameCtx.lineWidth = 5;
                gameCtx.strokeRect(this.x, this.y, this.width, this.height);

                // Sombra para efecto 3D
                gameCtx.fillStyle = '#8F2300';
                gameCtx.beginPath();
                gameCtx.moveTo(this.x, this.y + this.height);
                gameCtx.lineTo(this.x + 5, this.y + this.height + 5);
                gameCtx.lineTo(this.x + this.width + 5, this.y + this.height + 5);
                gameCtx.lineTo(this.x + this.width, this.y + this.height);
                gameCtx.closePath();
                gameCtx.fill();
                gameCtx.beginPath();
                gameCtx.moveTo(this.x + this.width, this.y);
                gameCtx.lineTo(this.x + this.width + 5, this.y + 5);
                gameCtx.lineTo(this.x + this.width + 5, this.y + this.height + 5);
                gameCtx.lineTo(this.x + this.width, this.y + this.height);
                gameCtx.closePath();
                gameCtx.fill();

                // Signo de interrogación
                gameCtx.fillStyle = 'white';
                gameCtx.font = 'bold 50px "Press Start 2P"';
                gameCtx.textAlign = 'center';
                gameCtx.textBaseline = 'middle';
                gameCtx.fillText('?', this.x + this.width / 2, this.y + this.height / 2 + 5);
            }
        }
        
        // --- Clase para el Jugador (la mano) ---
        class Player {
            constructor(landmarks) {
                this.landmarks = landmarks;
                this.state = {
                    isFirstFrame: true,
                    smoothedPoint: { x: 0, y: 0 }, // nudillo del dedo índice
                    verticalVelocity: 0,
                    lastY: 0
                };
            }
            
            update(landmarks) {
                this.landmarks = landmarks;
            }

            process() {
                const indexKuckle = this.landmarks[5]; // Usamos el nudillo para más estabilidad
                const currentPoint = { x: indexKuckle.x * gameCanvas.width, y: indexKuckle.y * gameCanvas.height };
                
                if (this.state.isFirstFrame) {
                    this.state.smoothedPoint.x = currentPoint.x;
                    this.state.smoothedPoint.y = currentPoint.y;
                    this.state.lastY = currentPoint.y;
                    this.state.isFirstFrame = false;
                }

                this.state.smoothedPoint.x += (currentPoint.x - this.state.smoothedPoint.x) * smoothingFactor;
                this.state.smoothedPoint.y += (currentPoint.y - this.state.smoothedPoint.y) * smoothingFactor;
                
                // Calcular velocidad vertical para detectar el "salto" o "golpe"
                this.state.verticalVelocity = this.state.smoothedPoint.y - this.state.lastY;
                this.state.lastY = this.state.smoothedPoint.y;
            }

            isPunching() {
                // Un valor negativo grande significa un movimiento rápido hacia arriba
                return this.state.verticalVelocity < -PUNCH_VELOCITY_THRESHOLD;
            }

            drawHand() {
                drawConnectors(gameCtx, this.landmarks, HAND_CONNECTIONS, { color: '#FFFFFF', lineWidth: 6 });
                drawConnectors(gameCtx, this.landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 4 });
                drawLandmarks(gameCtx, this.landmarks, { color: 'white', lineWidth: 2, radius: 4 });
            }
        }

        function isPointInsideRect(point, rect) {
             return point.x > rect.x && point.x < rect.x + rect.width && 
                    point.y > rect.y && point.y < rect.y + rect.height;
        }

        function onResults(results) {
            gameCtx.save();
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // --- LÓGICA DEL JUEGO ---
            
            // 1. Actualizar y dibujar bloques
            blockSpawnTimer++;
            if (blockSpawnTimer > 100) { // Genera un bloque cada 100 frames aprox.
                blocks.push(new Block());
                blockSpawnTimer = 0;
            }
            
            blocks.forEach(block => {
                block.update();
                block.draw();
            });
            
            // 2. Actualizar Jugador
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const handLandmarks = results.multiHandLandmarks[0]; // Solo nos importa la primera mano
                if (!player) {
                    player = new Player(handLandmarks);
                }
                player.update(handLandmarks);
                player.process();
                player.drawHand();

                // 3. Detección de Colisiones
                blocks.forEach(block => {
                    if (block.active && player.isPunching() && isPointInsideRect(player.state.smoothedPoint, block)) {
                        block.active = false; // "Rompemos" el bloque
                        score++;
                    }
                });
            } else {
                player = null; // Si no se detecta mano, no hay jugador
            }
            
            // 4. Eliminar bloques inactivos
            blocks = blocks.filter(block => block.active);

            // 5. Dibujar Puntuación
            gameCtx.fillStyle = 'white';
            gameCtx.font = '36px "Press Start 2P"';
            gameCtx.textAlign = 'left';
            gameCtx.textBaseline = 'top';
            gameCtx.shadowColor = 'black';
            gameCtx.shadowBlur = 5;
            gameCtx.fillText(`Puntos: ${score}`, 20, 20);
            gameCtx.shadowBlur = 0;


            gameCtx.restore();
        }

        function resizeCanvases() {
            const videoWidth = videoElement.videoWidth;
            const videoHeight = videoElement.videoHeight;
            if (!videoWidth) return;
            gameCanvas.width = videoWidth;
            gameCanvas.height = videoHeight;
        }
        
        async function startCamera() {
            loadingElement.style.display = 'block';
            if (activeStream) { activeStream.getTracks().forEach(track => track.stop()); }
            const constraints = { video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' } };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                activeStream = stream;
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    loadingElement.style.display = 'none';
                    resizeCanvases();
                    if (!handsInitialized) {
                        hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
                        hands.setOptions({
                            maxNumHands: 1, // Solo necesitamos una mano para el juego
                            modelComplexity: 1,
                            minDetectionConfidence: 0.6,
                            minTrackingConfidence: 0.6
                        });
                        hands.onResults(onResults);
                        sendToHands();
                        handsInitialized = true;
                    }
                };
            } catch (err) {
                loadingElement.style.display = 'none';
                console.error("Error al iniciar la cámara:", err);
            }
        }
        
        async function sendToHands() {
            if (videoElement.readyState >= 3) {
                await hands.send({ image: videoElement });
            }
            requestAnimationFrame(sendToHands);
        }
        
        startButton.addEventListener('click', () => {
            overlay.style.display = 'none';
            startCamera();
        });
        
        window.addEventListener('resize', resizeCanvases);
    </script>
</body>
</html>